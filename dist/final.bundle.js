(()=>{"use strict";let e=new class{constructor(){this.map=null,this.lat=48.8737815,this.lng=2.3501649,this.service=null,this.markers=[],this.data=null,this.coordoneees=null,this.submitReview(),this.submitRestaurant(),this.indexActif=0}createMap(){(async()=>{let e=await new Promise(((e,t)=>{navigator.geolocation.getCurrentPosition(e,t)})),t=e.coords.latitude,n=e.coords.longitude;null!==t&&null!==n&&(this.lat=e.coords.latitude,this.lng=e.coords.longitude)})().then((e=>{this.map=new google.maps.Map(document.getElementById("map"),{center:{lat:this.lat,lng:this.lng},zoom:10,mapId:"6f02331cadafb87d"});let t={location:this.map.center,radius:"500",type:["restaurant"]};this.service=new google.maps.places.PlacesService(this.map),this.service.nearbySearch(t,((e,t)=>{t==google.maps.places.PlacesServiceStatus.OK&&this.showRestaurant(e)})),this.map.addListener("click",(e=>{event.stopPropagation(),document.getElementById("addname").value="",this.addNewRestaurant(),this.coordoneees=e.latLng})),this.map.addListener("dragend",(()=>{let e=this.map.getCenter(),t=e.lat(),n=e.lng();this.map.setCenter(new google.maps.LatLng(t,n),20);let a={location:this.map.center,radius:"1000",type:["restaurant"]},s=document.getElementById("restaurants");for(;s.firstChild;)s.removeChild(s.firstChild);for(let e=0;e<this.markers.length;e++)this.markers[e].setMap(null);this.markers=[],this.data=null,this.service=new google.maps.places.PlacesService(this.map),this.service.nearbySearch(a,((e,t)=>{t==google.maps.places.PlacesServiceStatus.OK&&this.showRestaurant(e)}))}))}))}showRestaurant(e){this.data=e,this.showDatas(),this.filter()}showDatas(){for(let e=0;e<this.data.length;e++){this.data[e].ratings=[],this.data[e].newratings=[],this.OnlineReviews(this.data[e]);const t=new google.maps.Marker({position:this.data[e].geometry.location,icon:"../img/picto-restau.png",map:this.map});this.markers.push(t);let n=document.createElement("article");n.id="restau"+e;let a=document.createElement("h2"),s=document.createElement("div"),i=document.createElement("p");i.className="restau-average",i.id="restau-average"+e,s.className="restau-review",s.id="restau-review"+e;let l=document.createElement("img");l.src="../img/star.svg";let r=document.createElement("button");r.id="show-restau-review"+e,r.className="avis";let d=document.createElement("button");d.id="add-restau-review"+e,d.className="avis";let o=document.createElement("p");a.textContent=this.data[e].name,i.textContent=this.reviewsAverage(this.data[e]),r.textContent="Voir les avis",d.textContent="Ajouter un avis",o.textContent=this.data[e].vicinity,n.appendChild(a),n.appendChild(s),n.appendChild(o),s.appendChild(i),s.appendChild(l),s.appendChild(r),s.appendChild(d),document.getElementById("restaurants").appendChild(n),document.getElementById("show-restau-review"+e).addEventListener("click",(t=>{t.stopPropagation(),this.showReview(this.data[e])})),document.getElementById("add-restau-review"+e).addEventListener("click",(t=>{t.stopPropagation(),document.getElementById("addstars").value="",document.getElementById("addcomment").value="",this.addReview(e)}))}}filter(){document.getElementById("btnfiltre").addEventListener("click",(e=>{e.stopPropagation();let t=document.getElementById("min").value,n=document.getElementById("max").value;if(t>0&&t<=5&&n>0&&n<=5&&t<n){document.getElementById("nofilter").style.display="none";for(let e=0;e<this.data.length;e++){let a=this.reviewsAverage(this.data[e]);a>=t&&a<=n?(this.markers[e].setVisible(!0),document.getElementById("restau"+e).style.display="block"):(this.markers[e].setVisible(!1),document.getElementById("restau"+e).style.display="none")}}else t>n?(document.getElementById("nofilter").innerHTML="Le nombre minimum ne peut pas être supérieur au nombre maximum",document.getElementById("nofilter").style.display="block"):(t<1||t>5||n<1||n>5)&&(document.getElementById("nofilter").innerHTML="Veuillez saisir des nombres entre 1 et 5",document.getElementById("nofilter").style.display="block")}))}OnlineReviews(e){let t={placeId:e.place_id};this.service=new google.maps.places.PlacesService(this.map),this.service.getDetails(t,((t,n)=>{n==google.maps.places.PlacesServiceStatus.OK&&$.each(t.reviews,(function(t,n){e.ratings.push({stars:Number(n.rating),comment:n.text})}))}))}reviewsAverage(e){if(e.rating&&0==e.newratings.length)return e.rating;if(void 0===e.rating&&0!==e.newratings.length){let t=0;for(let n=0;n<e.newratings.length;n++)t+=e.newratings[n];return(t/e.newratings.length).toFixed(1)}if(e.rating&&0!==e.newratings.length){let t=e.user_ratings_total,n=t*e.rating,a=e.newratings.length,s=0;for(let t=0;t<a;t++)s+=e.newratings[t];return((n+s)/(t+a)).toFixed(1)}return"Aucun avis"}showReview(e){let t=null,n=null;"function"==typeof e.geometry.location.lat?(t=e.geometry.location.lat(),n=e.geometry.location.lng()):(t=e.geometry.location.lat,n=e.geometry.location.lng),document.getElementById("popup-reviews").style.opacity=1,document.getElementById("popup-reviews").style.zIndex=99,document.getElementById("popup-reviews").innerHTML=`\n                <div class="row intro">\n                    <div class="col-4">\n                        <img src="https://maps.googleapis.com/maps/api/streetview?location=${t},${n}&size=456x456&key=AIzaSyDBfmbrD5_qsRTRmHXRd_vOb1xR_kJ8B0o" alt="">\n                    </div>\n                    <div class="col-8">\n                        <h2> ${e.name} </h2>\n                        <div class="restau-review"> <p>Note : ${this.reviewsAverage(e)}</p> <img src="../img/star.svg">  </div>\n                        <img class="close" src="../img/close.svg">\n                    </div>\n                </div>\n                <div id="reviews-list">\n                </div>\n                `;for(let t=0;t<e.ratings.length;t++)document.getElementById("reviews-list").innerHTML+=`\n                    <div class="review ">\n                    <div class="number"> <p>${e.ratings[t].stars}</p> <img src="../img/star.svg">  </div>\n                    <p> ${e.ratings[t].comment} </p>\n                    </div>\n                    `;$(".close").click((function(){document.getElementById("popup-reviews").style.opacity=0,document.getElementById("popup-reviews").style.zIndex=-1}))}addReview(e){document.getElementById("popup-add-review").style.display="block",document.getElementById("popup-title").textContent=this.data[e].name,document.getElementById("close-popup").addEventListener("click",(e=>{e.preventDefault(),document.getElementById("popup-add-review").style.display="none"})),this.indexActif=e}submitReview(){document.getElementById("submit1").addEventListener("click",(e=>{e.preventDefault(),e.stopPropagation();let t=document.getElementById("addstars").value.trim(),n=document.getElementById("addcomment").value.trim();""!==t&&t>0&&t<=5&&""!==n?(this.data[this.indexActif].ratings.push({stars:Number(t),comment:n}),this.data[this.indexActif].newratings.push(Number(t)),document.getElementById("popup-add-review").style.display="none",document.getElementById("restau-average"+this.indexActif).textContent=this.reviewsAverage(this.data[this.indexActif]),this.showReview(this.data[this.indexActif])):""==n?document.getElementById("errorcomment").innerHTML="Ce champ est obligatoire":""==t?document.getElementById("errorstars").innerHTML="Ce champ est obligatoire":t<1||t>5?document.getElementById("errorstars").innerHTML="Entrez un nombre entre 1 et 5":alert("Remplissez tous les champs et assurez-vous que le nombre d'étoiles est bien compris entre 1 et 5")}))}addNewRestaurant(){document.getElementById("popup-add-restaurant").style.display="block",document.getElementById("close-popup2").addEventListener("click",(e=>{e.preventDefault(),document.getElementById("popup-add-restaurant").style.display="none"}))}submitRestaurant(){document.getElementById("submit2").addEventListener("click",(e=>{const t=e=>new Promise(((e,t)=>{let n=new google.maps.Geocoder;const a={lat:this.coordoneees.lat(),lng:this.coordoneees.lng()};n.geocode({location:a},((n,a)=>{"OK"===a?e(n[0].formatted_address):t(a)}))}));(async()=>{try{let e=await t();if(""!==n){this.data.push({name:n,geometry:{location:{lat:this.coordoneees.lat(),lng:this.coordoneees.lng()}},vicinity:e});const t=new google.maps.Marker({position:this.coordoneees,map:this.map,icon:"../img/picto-restau.png"});this.markers.push(t),this.map.panTo(this.coordoneees);let a=this.data.length-1;this.data[a].ratings=[],this.data[a].newratings=[];let s=document.createElement("article");s.id="restau"+a;let i=document.createElement("h2"),l=document.createElement("div"),r=document.createElement("p");r.className="restau-average",r.id="restau-average"+a,l.className="restau-review",l.id="restau-review"+a;let d=document.createElement("img");d.src="../img/star.svg";let o=document.createElement("button");o.id="show-restau-review"+a,o.className="avis";let m=document.createElement("button");m.id="add-restau-review"+a,m.className="avis";let c=document.createElement("p");i.textContent=this.data[a].name,r.textContent="Aucun avis",o.textContent="Voir les avis",m.textContent="Ajouter un avis",c.textContent=this.data[a].vicinity,s.appendChild(i),s.appendChild(l),s.appendChild(c),l.appendChild(r),l.appendChild(d),l.appendChild(o),l.appendChild(m),document.getElementById("restaurants").appendChild(s),document.getElementById("show-restau-review"+a).addEventListener("click",(e=>{e.stopPropagation(),this.showReview(this.data[a])})),document.getElementById("add-restau-review"+a).addEventListener("click",(e=>{e.stopPropagation(),document.getElementById("addstars").value="",document.getElementById("addcomment").value="",this.addReview(a)})),document.getElementById("popup-add-restaurant").style.display="none"}else alert("Remplissez les champs")}catch(e){console.log(e)}})(),e.preventDefault();let n=document.getElementById("addname").value.trim()}))}};window.initMap=function(){e.createMap()}})();